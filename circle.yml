# Initialize docker cmd
machine:
  services:
    - docker
# Build image from .dockerfile
dependencies:
  cache_directories:
    - ~/kubernetes
    - ~/docker
  override:
    - echo $NPM_TOKEN > ~/.npmrc
    - npm install
    - chmod +x tasks/crossbar/start.sh && tasks/crossbar/start.sh

test:
  override:
    - npm test
    - docker run -d ${EXTERNAL_REGISTRY_ENDPOINT}/authenticator:${CIRCLE_BRANCH}_${CIRCLE_SHA1}; sleep 10
    - chmod +x tasks/test.sh && tasks/test.sh

deployment:
  kubernetes:
    branch: [master, develop]
    commands:
      - chmod +x tasks/deploy/create-config.json.sh && tasks/deploy/create-config.json.sh
      - if [[ -e ~/docker/image.tar ]]; then docker load --input ~/docker/image.tar; fi
      - docker build -t ${EXTERNAL_REGISTRY_ENDPOINT}/authenticator:${CIRCLE_BRANCH}_${CIRCLE_SHA1} .
      - mkdir -p ~/docker; docker save ${EXTERNAL_REGISTRY_ENDPOINT}/authenticator:${CIRCLE_BRANCH}_${CIRCLE_SHA1} > ~/docker/image.tar
      - chmod +x tasks/deploy/auth-gcloud.sh && tasks/deploy/auth-gcloud.sh
      - gcloud docker push ${EXTERNAL_REGISTRY_ENDPOINT}/authenticator:${CIRCLE_BRANCH}_${CIRCLE_SHA1} > /dev/null
      - chmod +x tasks/deploy/deploy-to-kubernetes.sh && tasks/deploy/deploy-to-kubernetes.sh
